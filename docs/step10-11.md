# Steps 10-11: GeoJSON + Structure

## Step 10 - GeoJSON export + validation

Short explanation:
This script reads aggregated stats from PostgreSQL via SQLAlchemy, joins to the roads table, validates GeoJSON structure, and exports features. Each feature is a Point located at the road's longitude/latitude and includes avg_speed and congestion_index.

```python
# orm/geojson_export.py
import json
import os
from sqlalchemy import func
from sqlalchemy.orm import Session

from src.db import engine
from src.models import Road, TrafficHourlyStat

OUTPUT_PATH = os.getenv("GEOJSON_OUTPUT_PATH", "output/roads.geojson")

with Session(engine) as session:
    rows = (
        session.query(
            Road.road_id,
            Road.latitude,
            Road.longitude,
            func.avg(TrafficHourlyStat.avg_speed).label("avg_speed"),
            func.avg(TrafficHourlyStat.congestion_index).label("congestion_index")
        )
        .join(TrafficHourlyStat, TrafficHourlyStat.road_id == Road.road_id)
        .group_by(Road.road_id, Road.latitude, Road.longitude)
        .all()
    )

features = []
for r in rows:
    feature = {
        "type": "Feature",
        "geometry": {
            "type": "Point",
            "coordinates": [float(r.longitude), float(r.latitude)]
        },
        "properties": {
            "road_id": r.road_id,
            "avg_speed": float(r.avg_speed) if r.avg_speed is not None else None,
            "congestion_index": float(r.congestion_index) if r.congestion_index is not None else None
        }
    }
    features.append(feature)

geojson = {
    "type": "FeatureCollection",
    "features": features
}

validation_errors = validate_geojson(geojson)
if validation_errors:
    error_text = "\n".join(validation_errors)
    raise ValueError(f"GeoJSON validation failed:\n{error_text}")

os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=True)
with open(OUTPUT_PATH, "w", encoding="ascii") as f:
    json.dump(geojson, f, ensure_ascii=True)

print(f"GeoJSON exported to {OUTPUT_PATH}")
```

Example output (truncated):

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {"type": "Point", "coordinates": [29.0094, 41.0438]},
      "properties": {"road_id": "D-100", "avg_speed": 38.2, "congestion_index": 4.9}
    }
  ]
}
```

Map preview:
- Open map_preview/index.html
- Select output/roads.geojson using the file picker

## Step 11 - Project structure

Short explanation:
This layout keeps ingestion, storage, processing, and ORM artifacts cleanly separated while preserving the docs and source files you already have.

```
D:\proje4
?? docs/
?  ?? step2-4.md
?  ?? step4-6.md
?  ?? step7-9.md
?  ?? step10-11.md
?? schemas/
?  ?? traffic_event.schema.json
?? nifi/
?  ?? flow.md
?  ?? jolt_spec.json
?  ?? sample_input.json
?  ?? sample_output.json
?? hive/
?  ?? traffic_events.sql
?  ?? analytics.sql
?? spark/
?  ?? aggregate_hourly.py
?? orm/
?  ?? geojson_export.py
?? seed/
?  ?? seed_roads.py
?  ?? generate_sample_hourly.py
?? map_preview/
?  ?? index.html
?? output/
?  ?? roads.geojson
?? src/
   ?? analytics.py
   ?? create_tables.py
   ?? db.py
   ?? load_hourly_stats.py
   ?? models.py
```
